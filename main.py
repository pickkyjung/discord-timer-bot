import os
import discord
from discord.ext import commands, tasks
from datetime import datetime
from dotenv import load_dotenv
from flask import Flask
from threading import Thread
import pytz

load_dotenv()
TOKEN = os.getenv("TOKEN")
CHANNEL_ID = int(os.getenv("CHANNEL_ID"))

intents = discord.Intents.default()
bot = commands.Bot(command_prefix="!", intents=intents)

tz = pytz.timezone("Asia/Bangkok")

# ---------------------- Flask ----------------------
app = Flask(__name__)

@app.route('/')
def index():
    return "Bot is alive!"  # ЁЯСИ Keyword р╕Чр╕╡р╣И uptime robot р╕Ир╕░р╕Хр╕гр╕зр╕И

def run():
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 8080)))

def keep_alive():
    t = Thread(target=run)
    t.start()

# ---------------------------------------------------

weekly_schedule = {
    "daily": {
      "00:50": "ЁЯЫМЁЯТд р╕Фр╕╢р╕Бр╣Бр╕Др╣Ир╣Др╕лр╕Щр╕Бр╣Зр╕Хр╣Йр╕нр╕Зр╕Юр╕гр╣Йр╕нр╕б! р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯММ @everyone",
      "02:50": "р╕лр╕ер╕▒р╕Ър╕Бр╕▒р╕Щр╕вр╕▒р╕Зр╣Ар╕нр╣Ир╕в ! ЁЯТв р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╣Бр╕ер╣Йр╕зр╕Хр╣Ир╕н р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
      "03:50": "ЁЯТд р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕лр╕з р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯТАЁЯФо @everyone",
      "18:50": "ЁЯЪир╕Юр╕▒р╕Ър╣Ар╕Юр╕╡р╕вр╕Ър╕гр╕зр╕бр╕Хр╕▒р╕з ЁЯТе р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╕Хр╣Ир╕нр╕Фр╣Йр╕зр╕вр╕Лр╕▒р╕Ф р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
      "19:50": "тЪФя╕П р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯЫбя╕ПтЬи @everyone",
    },
    6: {
      "12:00": "тП░ р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Бр╕▒р╕Щр╕ер╕╖р╕б! р╕зр╕▒р╕Щр╕Щр╕╡р╣Йр╕бр╕╡ р╕Фр╕▒р╕Щр╕Бр╕┤р╕ер╕Фр╣М р╕Хр╕нр╕Щр╕кр╕▓р╕бр╕Чр╕╕р╣Ир╕бр╕Щр╕░р╕Др╕▒р╕Ър╕Ьр╕б ЁЯП░ЁЯФе @everyone",
      "18:50": "ЁЯЪир╕Юр╕▒р╕Ър╣Ар╕Юр╕╡р╕вр╕Ър╕гр╕зр╕бр╕Хр╕▒р╕з ЁЯТе р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╕Хр╣Ир╕нр╕Фр╣Йр╕зр╕вр╕Лр╕▒р╕Ф р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
      "19:50": "тЪФя╕П р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯЫбя╕ПтЬи @everyone",
      "20:30": "ЁЯУг р╕нр╕╡р╕Б 30 р╕Щр╕▓р╕Чр╕╡ р╕Ир╕░р╕ер╕З р╕Фр╕▒р╕Щр╕Бр╕┤р╕ер╕Фр╣М р╣Бр╕ер╣Йр╕зр╕зр╕з! р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╣Гр╕лр╣Йр╕Юр╕гр╣Йр╕нр╕бр╕Щр╕░р╕Др╕░ ЁЯТк @everyone",
      "20:55": "ЁЯЪи р╣Гр╕Др╕гр╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Ар╕Вр╣Йр╕▓р╕лр╣Йр╕нр╕Зр╣Ар╕кр╕╡р╕вр╕З р╕бр╕▓р╕Фр╣Ир╕зр╕Щ!! ЁЯОз р╕Фр╕▒р╕Щр╕Бр╕┤р╕ер╕Фр╣М р╕Ир╕░р╣Ар╕гр╕┤р╣Ир╕бр╣Бр╕ер╣Йр╕зр╕Др╣Ир╕░ тЪФя╕ПЁЯСС @everyone",
      "00:50": "ЁЯЫМЁЯТд р╕Фр╕╢р╕Бр╣Бр╕Др╣Ир╣Др╕лр╕Щр╕Бр╣Зр╕Хр╣Йр╕нр╕Зр╕Юр╕гр╣Йр╕нр╕б! р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯММ @everyone",
      "02:50": "р╕лр╕ер╕▒р╕Ър╕Бр╕▒р╕Щр╕вр╕▒р╕Зр╣Ар╕нр╣Ир╕в ! ЁЯТв р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╣Бр╕ер╣Йр╕зр╕Хр╣Ир╕н р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
      "03:50": "ЁЯТд р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕лр╕з р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯТАЁЯФо @everyone",
    }
}

@bot.event
async def on_ready():
    print(f"тЬЕ Logged in as {bot.user}")
    send_message.start()

@tasks.loop(seconds=60)
async def send_message():
    now = datetime.now(tz)
    time_now = now.strftime('%H:%M')
    weekday = now.weekday()

    messages = []

    if time_now in weekly_schedule["daily"]:
        messages.append(weekly_schedule["daily"][time_now])

    if weekday in weekly_schedule and time_now in weekly_schedule[weekday]:
        messages.append(weekly_schedule[weekday][time_now])

    if messages:
        channel = bot.get_channel(CHANNEL_ID)
        if channel:
            for msg in messages:
                await channel.send(msg)

# ---- р╣Ар╕гр╕╡р╕вр╕Бр╕Чр╕▒р╣Йр╕З Flask + Bot ----
keep_alive()
bot.run(TOKEN)
