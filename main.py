import os
import discord
from discord.ext import commands, tasks
from datetime import datetime
from dotenv import load_dotenv
from flask import Flask
from threading import Thread
import pytz

# р╣Вр╕лр╕ер╕Ф TOKEN / ID р╕Ир╕▓р╕Б .env
load_dotenv()
TOKEN = os.getenv("TOKEN")
CHANNEL_ID = int(os.getenv("CHANNEL_ID"))

# р╣Гр╕Кр╣Й intents р╣Бр╕Ър╕Ър╕бр╕╡ message content (р╕кр╕│р╕Др╕▒р╕Нр╕бр╕▓р╕Б)
intents = discord.Intents.default()
intents.message_content = True

bot = commands.Bot(command_prefix="!", intents=intents)
tz = pytz.timezone("Asia/Bangkok")

# == Flask р╕кр╕│р╕лр╕гр╕▒р╕Ъ uptime robot ==
app = Flask(__name__)

@app.route('/')
def index():
    return "Bot is alive!"

def run():
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 8080)))

def keep_alive():
    t = Thread(target=run)
    t.start()

# == р╕Хр╕▓р╕гр╕▓р╕Зр╣Ар╕зр╕ер╕▓р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б ==
weekly_schedule = {
    "daily": {
        "00:50": "ЁЯЫМЁЯТд р╕Фр╕╢р╕Бр╣Бр╕Др╣Ир╣Др╕лр╕Щр╕Бр╣Зр╕Хр╣Йр╕нр╕Зр╕Юр╕гр╣Йр╕нр╕б! р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯММ @everyone",
        "02:50": "р╕лр╕ер╕▒р╕Ър╕Бр╕▒р╕Щр╕вр╕▒р╕Зр╣Ар╕нр╣Ир╕в ! ЁЯТв р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╣Бр╕ер╣Йр╕зр╕Хр╣Ир╕н р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
        "03:50": "ЁЯТд р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕лр╕з р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯТАЁЯФо @everyone",
        "18:50": "ЁЯЪир╕Юр╕▒р╕Ър╣Ар╕Юр╕╡р╕вр╕Ър╕гр╕зр╕бр╕Хр╕▒р╕з ЁЯТе р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╕Хр╣Ир╕нр╕Фр╣Йр╕зр╕вр╕Лр╕▒р╕Ф р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
        "19:50": "тЪФя╕П р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯЫбя╕ПтЬи @everyone",
    },
    6: {
        "12:00": "тП░ р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Бр╕▒р╕Щр╕ер╕╖р╕б! р╕зр╕▒р╕Щр╕Щр╕╡р╣Йр╕бр╕╡ р╕Фр╕▒р╕Щр╕Бр╕┤р╕ер╕Фр╣М р╕Хр╕нр╕Щр╕кр╕▓р╕бр╕Чр╕╕р╣Ир╕бр╕Щр╕░р╕Др╕▒р╕Ър╕Ьр╕б ЁЯП░ЁЯФе @everyone",
        "18:50": "ЁЯЪир╕Юр╕▒р╕Ър╣Ар╕Юр╕╡р╕вр╕Ър╕гр╕зр╕бр╕Хр╕▒р╕з ЁЯТе р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╕Хр╣Ир╕нр╕Фр╣Йр╕зр╕вр╕Лр╕▒р╕Ф р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
        "19:50": "тЪФя╕П р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯЫбя╕ПтЬи @everyone",
        "20:30": "ЁЯУг р╕нр╕╡р╕Б 30 р╕Щр╕▓р╕Чр╕╡ р╕Ир╕░р╕ер╕З р╕Фр╕▒р╕Щр╕Бр╕┤р╕ер╕Фр╣М р╣Бр╕ер╣Йр╕зр╕зр╕з! р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╣Гр╕лр╣Йр╕Юр╕гр╣Йр╕нр╕бр╕Щр╕░р╕Др╕░ ЁЯТк @everyone",
        "20:55": "ЁЯЪи р╣Гр╕Др╕гр╕вр╕▒р╕Зр╣Др╕бр╣Ир╣Ар╕Вр╣Йр╕▓р╕лр╣Йр╕нр╕Зр╣Ар╕кр╕╡р╕вр╕З р╕бр╕▓р╕Фр╣Ир╕зр╕Щ!! ЁЯОз р╕Фр╕▒р╕Щр╕Бр╕┤р╕ер╕Фр╣М р╕Ир╕░р╣Ар╕гр╕┤р╣Ир╕бр╣Бр╕ер╣Йр╕зр╕Др╣Ир╕░ тЪФя╕ПЁЯСС @everyone",
        "00:50": "ЁЯЫМЁЯТд р╕Фр╕╢р╕Бр╣Бр╕Др╣Ир╣Др╕лр╕Щр╕Бр╣Зр╕Хр╣Йр╕нр╕Зр╕Юр╕гр╣Йр╕нр╕б! р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯММ @everyone",
        "02:50": "р╕лр╕ер╕▒р╕Ър╕Бр╕▒р╕Щр╕вр╕▒р╕Зр╣Ар╕нр╣Ир╕в ! ЁЯТв р╣Др╕Ыр╕нр╕▒р╕Ф р╕Ър╕нр╕кр╕Бр╕гр╕▓р╕б ЁЯТА р╣Бр╕ер╣Йр╕зр╕Хр╣Ир╕н р╕Ър╕нр╕кр╕Ър╕▒р╕ер╣Ар╕Фр╕нр╕гр╣М тЪФя╕П @everyone",
        "03:50": "ЁЯТд р╕Цр╣Йр╕▓р╕вр╕▒р╕Зр╣Др╕лр╕з р╣Ар╕Хр╕гр╕╡р╕вр╕бр╕Хр╕▒р╕зр╕ер╕З р╕зр╕▒р╕ер╕ор╕▒р╕ер╕ер╕▓ р╕Бр╕▒р╕Щр╕Щр╣Йр╕▓р╕▓р╕▓ ЁЯТАЁЯФо @everyone",
    }
}

# == р╕Ър╕нр╕Чр╕Юр╕гр╣Йр╕нр╕б ==
@bot.event
async def on_ready():
    print(f"тЬЕ Logged in as {bot.user}")
    send_message.start()

# == р╕кр╕▒р╣Ир╕З !test р╣Др╕Фр╣Й ==
@bot.command()
async def test(ctx):
    print(f"ЁЯУй р╕гр╕▒р╕Ър╕Др╕│р╕кр╕▒р╣Ир╕З !test р╕Ир╕▓р╕Б {ctx.author}")
    await ctx.send("р╕Ър╕нр╕Чр╕вр╕▒р╕Зр╕Чр╕│р╕Зр╕▓р╕Щр╕нр╕вр╕╣р╣Ир╕Щр╕░р╕Др╕гр╕▒р╕Ъ!")

# == р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Хр╕▓р╕бр╣Ар╕зр╕ер╕▓ ==
@tasks.loop(seconds=60)
async def send_message():
    now = datetime.now(tz)
    time_now = now.strftime('%H:%M')
    weekday = now.weekday()

    messages = []

    if time_now in weekly_schedule["daily"]:
        messages.append(weekly_schedule["daily"][time_now])

    if weekday in weekly_schedule and time_now in weekly_schedule[weekday]:
        messages.append(weekly_schedule[weekday][time_now])

    if messages:
        channel = bot.get_channel(CHANNEL_ID)
        if channel:
            for msg in messages:
                await channel.send(msg)

# == р╣Ар╕гр╕┤р╣Ир╕б Flask + р╕Ър╕нр╕Ч ==
keep_alive()
bot.run(TOKEN)
